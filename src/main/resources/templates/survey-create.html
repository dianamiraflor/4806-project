<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Create Survey</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link href="https://fonts.googleapis.com/css?family=Comfortaa:300&display=swap" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        body {
            font-family: 'Comfortaa', cursive;
            font-weight: 300;
            background-color: #f4f4f4;
            margin: 0;
            padding: 0;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            text-align: center;
        }

        h1 {
            font-size: 32px;
            color: #333;
            margin-bottom: 30px;
        }

        a.button {
            background-color: #007BFF;
            border: none;
            color: white;
            padding: 10px 20px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 16px;
            margin: 10px 2px;
            cursor: pointer;
            border-radius: 4px;
            transition: background-color 0.3s;
        }
        .delete-question {
            position: relative;
            margin-top: 5px ;
        }

        a.button:hover {
            background-color: #0056b3;
        }
    </style>
</head>
<body>
<div class="container">
    <h1>Create Survey</h1>
    <form action="/surveys/${surveyId}" th:action="@{/surveys/{surveyId}(surveyId=${surveyId})}" th:object="${survey}" method="post">
        <div class="form-group">
            <label for="surveyName">Survey Title:</label>
            <input type="text" id="surveyName" th:field="*{surveyName}" class="form-control"/>
        </div>
        <div id="questions"></div>
        <button id="add-question" type="button" class="btn btn-primary">Add Question</button>
        <button id="create-survey" type="submit" class="btn btn-primary" disabled>Create Survey</button>
    </form>
</div>
<script>
    function addChoiceInput(questionIndex) {
        const choiceIndex = $(`#question-${questionIndex} .choice`).length;
        const choiceHtml = `
            <div class="form-group choice">
                <label for="choice-text">Choice:</label>
                <input type="text" id="choice-text" name="questions[${questionIndex}].choices[${choiceIndex}]" class="form-control"/>
            </div>`;
        $(`#question-${questionIndex} .choices`).append(choiceHtml);
    }
    function updateQuestion(questionIndex) {
        const questionType = $(`#question-${questionIndex} select`).val();
        if (questionType === 'CHOICE') {
            if (!$(`#question-${questionIndex} .choices`).length) {
                $(`#question-${questionIndex}`).append('<div class="choices"></div>');
                addChoiceInput(questionIndex);
                $(`#question-${questionIndex}`).append('<button type="button" class="btn btn-secondary add-choice">Add Choice</button>');
            }
            // Remove range inputs when question type changes
            $(`#question-${questionIndex} .range-container`).remove();
        } else if (questionType === 'RANGE') {
            if (!$(`#question-${questionIndex} .range-container`).length) {
                const rangeHtml = `
                <div class="form-group range-container">
                    <label for="range-min">Min:</label>
                    <input type="number" id="range-min" name="questions[${questionIndex}].rangeMin" class="form-control"/>
                    <label for="range-max">Max:</label>
                    <input type="number" id="range-max" name="questions[${questionIndex}].rangeMax" class="form-control"/>
                </div>`;
                $(`#question-${questionIndex}`).append(rangeHtml);
            }
            // Remove choice inputs when question type changes
            $(`#question-${questionIndex} .choices`).remove();
            $(`#question-${questionIndex} .add-choice`).remove();
        } else {
            // Remove choice inputs and range inputs when question type changes
            $(`#question-${questionIndex} .choices`).remove();
            $(`#question-${questionIndex} .add-choice`).remove();
            $(`#question-${questionIndex} .range-container`).remove();
        }
    }




    function updateCreateSurveyButton() {
        const title = $('#surveyName').val().trim();
        const questions = $('#questions .question');
        let validQuestions = 0;

        questions.each(function() {
            const questionText = $(this).find('#question-text').val().trim();
            const questionType = $(this).find('#question-type').val();
            const choices = $(this).find('.choice #choice-text').filter(function() {
                return this.value.trim() !== '';
            });

            if (questionText.length > 0) {
                if (questionType === 'CHOICE') {
                    if (choices.length >= 2) {
                        validQuestions++;
                    }
                } else if (questionType === 'RANGE') {
                    const rangeMin = $(this).find('.range-container #range-min').val().trim();
                    const rangeMax = $(this).find('.range-container #range-max').val().trim();

                    if (rangeMin.length > 0 && rangeMax.length > 0 && parseInt(rangeMin) <= parseInt(rangeMax)) {
                        validQuestions++;
                    }
                } else {
                    validQuestions++;
                }
            }
        });

        if (title.length > 0 && validQuestions > 0) {
            $('#create-survey').prop('disabled', false);
        } else {
            $('#create-survey').prop('disabled', true);
        }
    }


    $(document).ready(function() {
        $('#add-question').click(function() {
            const questionIndex = $('#questions .question').length;
            const questionHtml = `
                <div class="question" id="question-${questionIndex}">
                    <div class="form-group">
                        <label for="question-text">Question:</label>
                        <input type="text" id="question-text" name="questions[${questionIndex}].text" class="form-control"/>
                    </div>
                    <div class="form-group">
                        <label for="question-type">Type:</label>
                    <select id="question-type" name="questions[${questionIndex}].type" class="form-control" onchange="updateQuestion(${questionIndex})">
                        <option value="TEXT">TEXT</option>
                        <option value="RANGE">RANGE</option>
                        <option value="CHOICE">CHOICE</option>
                    </select>
                <button type="button" class="btn btn-danger delete-question">Delete Question</button>

                </div>

            </div>`;
            $('#questions').append(questionHtml);
            updateCreateSurveyButton();
        });

        $(document).on('click', '.add-choice', function() {
            const questionIndex = $(this).closest('.question').attr('id').split('-')[1];
            addChoiceInput(questionIndex);
        });

        $(document).on('click', '.delete-question', function() {
            $(this).closest('.question').remove();
            updateCreateSurveyButton();
        });


        // Update the Create Survey button when the title or question text changes
        $(document).on('input', '#title', updateCreateSurveyButton);
        $(document).on('input', '#question-text', updateCreateSurveyButton);
        $(document).on('input', '.choice #choice-text', updateCreateSurveyButton);
        $(document).on('change', '#question-type', updateCreateSurveyButton);
        $(document).on('input', '.range-container #range-min', updateCreateSurveyButton);
        $(document).on('input', '.range-container #range-max', updateCreateSurveyButton);

    });
</script>
</body>
</html>